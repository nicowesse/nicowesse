function whichTransitionEvent(){var t,i=document.createElement("fakeelement"),e={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in e)if(void 0!==i.style[t])return e[t]}!function($,t){var i=function(t,i,e){var a;return function n(){function n(){e||t.apply(o,s),a=null}var o=this,s=arguments;a?clearTimeout(a):e&&t.apply(o,s),a=setTimeout(n,i||100)}};jQuery.fn[t]=function(e){return e?this.bind("resize",i(e)):this.trigger(t)}}(jQuery,"smartresize");var customTransitionEnd=whichTransitionEvent();!function($){var t=0;$.fn.fluidbox=function(i){var e=$.extend(!0,{viewportFill:.95,debounceResize:!0,stackIndex:1e3,stackIndexDelta:10,closeTrigger:[{selector:".fluidbox-overlay",event:"click"},{selector:"document",event:"keyup",keyCode:27}]},i);e.stackIndex<e.stackIndexDelta&&(e.stackIndexDelta=e.stackIndex),$fbOverlay=$("<div />",{"class":"fluidbox-overlay",css:{"z-index":e.stackIndex}});var a=this,n=$(window),o,s=function(t){$(t+".fluidbox-opened").trigger("click")},d=function(t,i){var a=t.find("img"),s=t.find(".fluidbox-ghost"),d=t.find(".fluidbox-wrap"),r=t.data(),c=0,l=0;a.data().imgRatio=r.natWidth/r.natHeight;var f,h,u;if(o>a.data().imgRatio)c=r.natHeight<n.height()*e.viewportFill?r.natHeight:n.height()*e.viewportFill,r.imgScale=c/a.height(),r.imgScaleY=r.imgScale,f=a.height()*r.imgScaleY,h=f/r.natHeight,u=r.natWidth*h/a.width(),r.imgScaleX=u;else{l=r.natWidth<n.width()*e.viewportFill?r.natWidth:n.width()*e.viewportFill,r.imgScale=l/a.width(),r.imgScaleX=r.imgScale;var g=a.width()*r.imgScaleX,h=g/r.natWidth,u=r.natHeight*h/a.height();r.imgScaleY=u}var p=n.scrollTop()-a.offset().top+.5*a.data("imgHeight")*(a.data("imgScale")-1)+.5*(n.height()-a.data("imgHeight")*a.data("imgScale")),m=.5*a.data("imgWidth")*(a.data("imgScale")-1)+.5*(n.width()-a.data("imgWidth")*a.data("imgScale"))-a.offset().left,x=parseInt(1e3*r.imgScaleX)/1e3+","+parseInt(1e3*r.imgScaleY)/1e3;s.css({transform:"translate("+parseInt(10*m)/10+"px,"+parseInt(10*p)/10+"px) scale("+x+")",top:a.offset().top-d.offset().top,left:a.offset().left-d.offset().left}).one(customTransitionEnd,function(){t.trigger(i)})},r=function(t){function i(){r.imgWidth=a.width(),r.imgHeight=a.height(),r.imgRatio=a.width()/a.height(),s.css({width:a.width(),height:a.height(),top:a.offset().top-d.offset().top+parseInt(a.css("borderTopWidth"))+parseInt(a.css("paddingTop")),left:a.offset().left-d.offset().left+parseInt(a.css("borderLeftWidth"))+parseInt(a.css("paddingLeft"))}),r.imgScale=o>r.imgRatio?n.height()*e.viewportFill/a.height():n.width()*e.viewportFill/a.width()}if(o=n.width()/n.height(),t.hasClass("fluidbox")){var a=t.find("img"),s=t.find(".fluidbox-ghost"),d=t.find(".fluidbox-wrap"),r=a.data();i(),a.load(i)}},c=function(t){if($(this).hasClass("fluidbox")){var i=$(this),a=$(this).find("img"),n=$(this).find(".fluidbox-ghost"),o=$(this).find(".fluidbox-wrap"),s={};0!==$(this).data("fluidbox-state")&&$(this).data("fluidbox-state")?(i.trigger("closestart"),i.data("fluidbox-state",0).removeClass("fluidbox-opened").addClass("fluidbox-closed"),s.open&&window.clearTimeout(s.open),s.close=window.setTimeout(function(){$(".fluidbox-overlay").remove(),o.css({"z-index":e.stackIndex-e.stackIndexDelta})},10),$(".fluidbox-overlay").css({opacity:0}),n.css({transform:"translate(0,0) scale(1)",opacity:0,top:a.offset().top-o.offset().top+parseInt(a.css("borderTopWidth"))+parseInt(a.css("paddingTop")),left:a.offset().left-o.offset().left+parseInt(a.css("borderLeftWidth"))+parseInt(a.css("paddingLeft"))}).one(customTransitionEnd,function(){i.trigger("closeend")}),a.css({opacity:1})):($(this).trigger("openstart"),$("<img />",{src:a.attr("src")}).load(function(){$("<img />",{src:i.attr("href")}).load(function(){i.data("natWidth",$(this)[0].naturalWidth).data("natHeight",$(this)[0].naturalHeight),i.append($fbOverlay).data("fluidbox-state",1).removeClass("fluidbox-closed").addClass("fluidbox-opened"),s.close&&window.clearTimeout(s.close),s.open=window.setTimeout(function(){$(".fluidbox-overlay").css({opacity:1})},10),$(".fluidbox-wrap").css({zIndex:e.stackIndex-e.stackIndexDelta-1}),o.css({"z-index":e.stackIndex+e.stackIndexDelta}),n.css({"background-image":"url("+a.attr("src")+")",opacity:1}),a.css({opacity:0}),n.css({"background-image":"url("+i.attr("href")+")"}),d(i,"openend")})})),t.preventDefault()}},l=function(t){t?r(t):a.each(function(){r($(this))});var i=$("a.fluidbox.fluidbox-opened");i.length>0&&d(i,"resizeend")};return e.debounceResize?$(window).smartresize(function(){l()}):$(window).resize(function(){l()}),a.each(function(i){if($(this).is("a")&&1===$(this).children().length&&$(this).children().is("img")&&"none"!==$(this).css("display")&&"none"!==$(this).parents().css("display")){var a=$("<div />",{"class":"fluidbox-wrap",css:{"z-index":e.stackIndex-e.stackIndexDelta}});t+=1;var o=$(this);o.addClass("fluidbox").attr("id","fluidbox-"+t).wrapInner(a).find("img").css({opacity:1}).after('<div class="fluidbox-ghost" />').each(function(){var t=$(this);t.width()>0&&t.height()>0?(r(o),o.click(c)):t.load(function(){r(o),o.click(c)})}),$(this).on("recompute",function(){l($(this)),$(this).trigger("recomputeend")});var d="#fluidbox-"+t;e.closeTrigger&&$.each(e.closeTrigger,function(t){var i=e.closeTrigger[t];"window"!=i.selector?"document"==i.selector&&(i.keyCode?$(document).on(i.event,function(t){t.keyCode==i.keyCode&&s(d)}):$(document).on(i.event,d,function(){s(d)})):n.on(i.event,function(){s(d)})})}}),a}}(jQuery);